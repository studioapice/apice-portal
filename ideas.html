<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ápice Studio | Ideas Creativas</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    /* VARIABLES */
    :root {
      --apice-green: #8DA399;
      --apice-bg: #F7F6F2;
      --text-main: #1A1A1A;
      --text-soft: #666666;
      --white: #FFFFFF;
      --client-idea-bg: #F0EEE9; 
      --border: rgba(0,0,0,0.08);
      --glass: rgba(255, 255, 255, 0.95);
      --font-serif: 'Cormorant Garamond', serif;
      --font-sans: 'Inter', sans-serif;
      --font-display: 'Playfair Display', serif;
      --ease: cubic-bezier(0.23, 1, 0.32, 1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    
    body {
      background: var(--apice-bg); color: var(--text-main); font-family: var(--font-sans);
      min-height: 100vh; overflow-x: hidden;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
    }

    .ambient-light { position: fixed; bottom: -10%; left: -10%; width: 60vw; height: 60vw; background: radial-gradient(circle, rgba(141,163,153,0.1) 0%, rgba(255,255,255,0) 60%); filter: blur(90px); z-index: -1; pointer-events: none; }

    .app-container { display: grid; grid-template-columns: 300px 1fr; min-height: 100vh; }

    /* MENU FLOTANTE */
    .floating-nav-container { position: fixed; top: 40px; right: 50px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; }
    .menu-trigger { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; cursor: pointer; transition: 0.3s var(--ease); box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.6); }
    .menu-trigger span { width: 24px; height: 1.5px; background-color: var(--text-main); transition: 0.3s; }
    .menu-trigger.active { background: var(--white); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    
    .nav-dropdown { position: absolute; top: 60px; right: 0; width: 220px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); border-radius: 16px; padding: 20px 0; box-shadow: 0 20px 60px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.5); opacity: 0; transform: translateY(-10px) scale(0.95); pointer-events: none; transition: all 0.4s var(--ease); transform-origin: top right; }
    .nav-dropdown.is-open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
    .nav-link { display: block; padding: 12px 25px; font-size: 13px; color: var(--text-soft); text-decoration: none; transition: 0.2s; letter-spacing: 0.5px; }
    .nav-link:hover { background: rgba(141, 163, 153, 0.08); color: var(--text-main); padding-left: 30px; }
    .nav-divider { height: 1px; background: rgba(0,0,0,0.05); margin: 10px 0; }
    .nav-link.danger { color: #D45D5D; }

    /* SIDEBAR */
    .sidebar { position: sticky; top: 0; height: 100vh; padding: 60px 40px; display: flex; flex-direction: column; justify-content: space-between; border-right: 1px solid rgba(0,0,0,0.05); background: var(--glass); backdrop-filter: blur(30px); z-index: 50; }
    .brand { font-family: var(--font-serif); font-size: 28px; letter-spacing: 0.02em; margin-bottom: 60px; display: block; color: var(--text-main); text-decoration: none; }
    
    .nav-section { display: flex; flex-direction: column; gap: 8px; margin-top: 20px; }
    .side-nav-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #999; text-decoration: none; transition: 0.3s; cursor: pointer; }
    .side-nav-item:hover, .side-nav-item.active { color: var(--apice-green); padding-left: 10px; font-weight: 600; }
    .side-nav-item.active { border-left: 2px solid var(--apice-green); padding-left: 15px; }

    .user-mini { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); }
    .user-name { font-size: 12px; font-weight: 600; display: block; }
    .user-role { font-size: 11px; color: #999; }

    /* MAIN CONTENT */
    .main-content { padding: 60px 80px; overflow-y: auto; padding-bottom: 120px; }
    
    .header-section { margin-bottom: 40px; display: flex; justify-content: space-between; align-items: flex-end; }
    .page-title { font-family: var(--font-serif); font-size: 48px; font-weight: 400; color: var(--text-main); margin-bottom: 10px; }
    .subtitle { font-size: 14px; color: var(--text-soft); max-width: 500px; line-height: 1.6; }

    .btn-primary { background: var(--text-main); color: white; border: none; padding: 12px 24px; border-radius: 30px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
    .btn-primary:hover { background: var(--apice-green); transform: translateY(-2px); }

    /* PROGRESS BAR */
    .progress-section {
      background: var(--white); padding: 25px 30px; border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.03); margin-bottom: 40px;
      display: flex; align-items: center; justify-content: space-between;
      gap: 40px; border: 1px solid rgba(255,255,255,0.6);
      animation: fadeIn 0.8s var(--ease) backwards;
    }
    .prog-info h3 { font-size: 14px; margin-bottom: 5px; font-weight: 500; }
    .prog-info p { font-size: 12px; color: var(--text-soft); }
    .prog-bar-wrapper { flex: 1; height: 6px; background: #EEE; border-radius: 10px; overflow: hidden; position: relative; }
    .prog-fill { height: 100%; background: var(--apice-green); width: 0%; transition: width 1s var(--ease); border-radius: 10px; }
    .prog-number { font-family: var(--font-display); font-size: 32px; color: var(--apice-green); min-width: 80px; text-align: right; }
    .prog-label { font-size: 10px; text-transform: uppercase; color: #999; display: block; text-align: right; margin-top: 4px; }

    /* MONTH NAVIGATION (NUEVO DISEÑO CENTRADO) */
    .month-nav-container {
        display: flex; align-items: center; justify-content: center; gap: 20px;
        margin-bottom: 40px; padding: 10px;
    }
    .month-display { font-family: var(--font-display); font-size: 24px; color: var(--text-main); min-width: 180px; text-align: center; }
    .nav-arrow { 
        width: 40px; height: 40px; border: 1px solid var(--border); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        transition: 0.3s; background: var(--white); color: var(--text-main); font-size: 18px;
    }
    .nav-arrow:hover { border-color: var(--apice-green); color: var(--apice-green); transform: scale(1.05); }

    /* TABS */
    .tabs-container { display: flex; gap: 30px; margin-bottom: 30px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .tab-item { 
        padding-bottom: 15px; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; 
        color: #999; cursor: pointer; transition: 0.3s; position: relative;
    }
    .tab-item:hover { color: var(--text-main); }
    .tab-item.active { color: var(--text-main); font-weight: 600; }
    .tab-item.active::after { 
        content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: var(--apice-green); 
    }

    /* GRID IDEAS */
    .ideas-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }

    .idea-card {
        background: var(--white); border-radius: 12px; padding: 30px;
        border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s var(--ease);
        display: flex; flex-direction: column; position: relative;
        cursor: default; min-height: 250px;
    }
    .idea-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.04); }

    .idea-card.is-client { background: var(--client-idea-bg); border: 1px dashed #D4A373; }
    .idea-card.is-client::after {
        content: 'TU PROPUESTA'; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
        background: #D4A373; color: white; font-size: 9px; font-weight: 700;
        padding: 4px 10px; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; letter-spacing: 1px;
    }

    .idea-card.approved {
        border-color: var(--apice-green); border-style: solid; background: #F2F8F5; 
        box-shadow: 0 10px 30px rgba(141, 163, 153, 0.15);
    }
    .idea-card.approved::before {
        content: 'SELECCIONADA'; position: absolute; top: 20px; right: 20px;
        font-size: 9px; color: var(--apice-green); font-weight: 700; letter-spacing: 1px; border: 1px solid var(--apice-green); padding: 4px 8px; border-radius: 4px; background: white;
    }

    .idea-type { font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: block; }
    .idea-title { font-family: var(--font-serif); font-size: 24px; line-height: 1.2; color: var(--text-main); margin-bottom: 15px; }
    .idea-desc { font-size: 14px; line-height: 1.6; color: var(--text-soft); margin-bottom: 30px; font-weight: 300; }

    .btn-select {
        margin-top: auto; width: 100%; padding: 12px; border-radius: 8px;
        border: 1px solid #E0E0E0; background: white; color: var(--text-soft);
        font-size: 12px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: 0.3s;
    }
    .btn-select:hover { border-color: var(--text-main); color: var(--text-main); }
    .idea-card.approved .btn-select { background: var(--apice-green); color: white; border-color: var(--apice-green); }
    .idea-card.approved .btn-select:hover { background: #7A9187; }

    /* SELECTION BAR */
    .selection-bar {
        position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
        background: var(--text-main); color: white; padding: 15px 30px;
        border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        display: flex; align-items: center; gap: 20px; z-index: 100;
        opacity: 0; transition: 0.5s var(--ease); pointer-events: none;
    }
    .selection-bar.visible { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: all; }
    .selection-count { font-size: 14px; font-weight: 500; }
    .selection-detail { font-size: 12px; color: rgba(255,255,255,0.6); margin-left: auto; }

    /* MODAL */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30,30,30,0.4); backdrop-filter: blur(5px); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .modal-overlay.active { opacity: 1; pointer-events: all; }
    .upload-modal { background: var(--white); width: 500px; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); transform: translateY(20px); transition: 0.4s var(--ease); }
    .modal-overlay.active .upload-modal { transform: translateY(0); }
    .modal-title { font-family: var(--font-display); font-size: 28px; margin-bottom: 25px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #999; margin-bottom: 8px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 8px; font-family: var(--font-sans); font-size: 14px; outline: none; }
    .form-textarea { resize: vertical; min-height: 100px; }
    .form-input:focus, .form-textarea:focus { border-color: var(--apice-green); }
    .close-modal { position: absolute; top: 20px; right: 20px; cursor: pointer; color: #999; font-size: 20px; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  </style>
</head>
<body>

  <div class="ambient-light"></div>

  <!-- MENÚ FLOTANTE -->
  <div class="floating-nav-container" id="navContainer">
    <div class="menu-trigger" id="menuTrigger">
      <span></span><span></span><span></span>
    </div>
    <div class="nav-dropdown" id="navDropdown">
      <a href="material.html" class="nav-link">Material</a>
      <a href="ideas.html" class="nav-link" style="color:var(--apice-green);">Ideas</a>
      <a href="documentos.html" class="nav-link">Documentos</a>
      <div class="nav-divider"></div>
      <a href="dashboard.html" class="nav-link">Volver al Dashboard</a>
      <a href="#" id="logoutBtn" class="nav-link danger">Cerrar Sesión</a>
    </div>
  </div>

  <div class="app-container">
    
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div>
        <a href="dashboard.html" class="brand">Ápice Studio.</a>
        
        <nav class="nav-section">
          <div class="side-nav-item active" onclick="switchTab('reel')">
            <span>Propuestas Reels</span>
          </div>
          <div class="side-nav-item" onclick="switchTab('carrusel')">
            <span>Propuestas Carruseles</span>
          </div>
        </nav>
      </div>

      <div class="user-mini">
        <span class="user-name" id="userName">Cargando...</span>
        <span class="user-role">Cuenta Premium</span>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main-content">
      
      <header class="header-section">
        <div>
          <h1 class="page-title">Lluvia de Ideas</h1>
          <p class="subtitle">Selecciona las propuestas de contenido para este mes.</p>
        </div>
        
        <button class="btn-primary" onclick="openModal()">
            <span>+</span> Nueva Idea
        </button>
      </header>

      <!-- BARRA DE PROGRESO -->
      <section class="progress-section">
        <div class="prog-info">
          <h3 id="goalTitle">Meta de Reels</h3>
          <p>Ideas seleccionadas vs. Objetivo mensual</p>
        </div>
        <div class="prog-bar-wrapper">
          <div class="prog-fill" id="progressBar"></div>
        </div>
        <div>
          <div class="prog-number" id="progressText">0/12</div>
          <span class="prog-label">Seleccionadas</span>
        </div>
      </section>

      <!-- NAVEGACIÓN DE MES (AHORA AQUÍ) -->
      <div class="month-nav-container">
        <button class="nav-arrow" onclick="changeMonth(-1)">←</button>
        <div class="month-display" id="monthDisplay">Cargando...</div>
        <button class="nav-arrow" onclick="changeMonth(1)">→</button>
      </div>

      <!-- TABS -->
      <div class="tabs-container">
        <div class="tab-item active" id="tab-reel" onclick="switchTab('reel')">Reels</div>
        <div class="tab-item" id="tab-carrusel" onclick="switchTab('carrusel')">Carruseles</div>
      </div>

      <!-- GRID -->
      <div class="ideas-grid" id="ideasGrid">
        <p style="color:#999;">Cargando propuestas...</p>
      </div>

    </main>
  </div>

  <!-- BARRA DE SELECCIÓN -->
  <div class="selection-bar" id="selectionBar">
    <span class="selection-count" id="selectionText">0 ideas seleccionadas</span>
    <span class="selection-detail">Sugerido: 8 a 12</span>
  </div>

  <!-- MODAL NUEVA IDEA -->
  <div class="modal-overlay" id="ideaModal">
    <div class="upload-modal">
      <div class="close-modal" onclick="closeModal()">✕</div>
      <h2 class="modal-title">Agregar Mi Propuesta</h2>
      
      <div class="form-group">
        <label class="form-label">Título / Gancho</label>
        <input type="text" id="ideaTitle" class="form-input" placeholder="Ej: 3 Mitos del sector...">
      </div>

      <div class="form-group">
        <label class="form-label">Formato</label>
        <select id="ideaType" class="form-select">
          <option value="reel">Reel</option>
          <option value="carrusel">Carrusel</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Descripción Estratégica</label>
        <textarea id="ideaDesc" class="form-textarea" placeholder="Describe el objetivo y enfoque del contenido..."></textarea>
      </div>

      <button class="btn-primary" style="width:100%; justify-content:center;" onclick="createIdea()">
        Guardar Propuesta
      </button>
    </div>
  </div>

  <!-- JAVASCRIPT -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // CLAVES
    const supabaseUrl = "https://jmfnwxnzxcfhvrmsmfip.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptZm53eG56eGNmaHZybXNtZmlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzEwMzcsImV4cCI6MjA4NDUwNzAzN30.KzyZy_S1ufhLkv63Kvmz9lm_UrDssvUE34FxGAPYxZw";
    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentUser = null;
    let allIdeas = [];
    let currentFilter = 'reel';
    let viewDate = new Date(); // Fecha visualizada

    // MENU FLOTANTE
    const navContainer = document.getElementById('navContainer');
    const navDropdown = document.getElementById('navDropdown');
    const menuTrigger = document.getElementById('menuTrigger');
    let menuTimer;
    navContainer.addEventListener('mouseenter', () => { clearTimeout(menuTimer); navDropdown.classList.add('is-open'); menuTrigger.classList.add('active'); });
    navContainer.addEventListener('mouseleave', () => { menuTimer = setTimeout(() => { navDropdown.classList.remove('is-open'); menuTrigger.classList.remove('active'); }, 4000); });

    // INIT
    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { window.location.href = "index.html"; return; }
      currentUser = session.user;
      
      const emailName = currentUser.email.split('@')[0];
      document.getElementById("userName").innerText = emailName.charAt(0).toUpperCase() + emailName.slice(1);

      updateMonthDisplay();
      await fetchIdeas();
    }

    // 1. GESTIÓN DE FECHAS
    window.changeMonth = (delta) => {
        viewDate.setMonth(viewDate.getMonth() + delta);
        updateMonthDisplay();
        renderIdeas();
    };

    function updateMonthDisplay() {
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const m = viewDate.getMonth();
        const y = viewDate.getFullYear();
        document.getElementById("monthDisplay").innerText = `${monthNames[m]} ${y}`;
    }

    // 2. OBTENER IDEAS
    async function fetchIdeas() {
        const { data, error } = await supabase
            .from('ideas')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error("ERROR SUPABASE:", error);
            alert("Error cargando ideas.");
        } else {
            allIdeas = data || [];
            renderIdeas();
        }
    }

    // 3. RENDERIZAR GRID (FILTRO CORREGIDO POR MES)
    function renderIdeas() {
        const grid = document.getElementById("ideasGrid");
        grid.innerHTML = "";

        // Filtro 1: Tipo
        let filtered = allIdeas.filter(i => i.tipo === currentFilter);

        // Filtro 2: Mes/Año
        filtered = filtered.filter(i => {
            // Usamos 'fecha' preferentemente, si no 'created_at'
            const dateStr = i.fecha || i.created_at; 
            if (!dateStr) return false;
            
            // Convertir string a fecha y comparar mes/año
            // Truco: Usamos la parte de fecha "YYYY-MM" para evitar líos de hora
            const itemDate = new Date(dateStr);
            // Comparar con viewDate
            return itemDate.getMonth() === viewDate.getMonth() && itemDate.getFullYear() === viewDate.getFullYear();
        });

        updateProgress(filtered);

        if (filtered.length === 0) {
            grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#999; border:2px dashed #E0E0E0; border-radius:12px;">No hay propuestas de ${currentFilter}s para este mes.</div>`;
            return;
        }

        filtered.forEach(idea => {
            const isApproved = idea.estado === 'aprobada';
            const isClientCreated = idea.origen === 'cliente';
            
            const card = document.createElement("div");
            card.className = `idea-card ${isApproved ? 'approved' : ''} ${isClientCreated ? 'is-client' : ''}`;
            
            card.innerHTML = `
                <span class="idea-type">${idea.tipo}</span>
                <h3 class="idea-title">${idea.titulo}</h3>
                <p class="idea-desc">${idea.descripcion}</p>
                <button class="btn-select" onclick="toggleIdeaStatus(${idea.id}, '${idea.estado}')">
                    ${isApproved ? 'Seleccionada ✓' : 'Seleccionar Idea'}
                </button>
            `;
            grid.appendChild(card);
        });
    }

    // 4. BARRA DE PROGRESO
    function updateProgress(monthIdeas) {
        const goal = currentFilter === 'reel' ? 12 : 6;
        document.getElementById("goalTitle").innerText = currentFilter === 'reel' ? 'Meta de Reels' : 'Meta de Carruseles';
        
        const approvedCount = monthIdeas.filter(i => i.estado === 'aprobada').length;
        const percent = Math.min((approvedCount / goal) * 100, 100);
        
        document.getElementById("progressBar").style.width = `${percent}%`;
        document.getElementById("progressText").innerText = `${approvedCount}/${goal}`;
    }

    // 5. CAMBIAR TABS
    window.switchTab = (type) => {
        currentFilter = type;
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${type}`).classList.add('active');
        document.querySelectorAll('.side-nav-item').forEach(el => el.classList.remove('active'));
        renderIdeas();
    }

    // 6. SELECCIONAR
    window.toggleIdeaStatus = async (id, currentStatus) => {
        const newStatus = currentStatus === 'aprobada' ? 'propuesta' : 'aprobada';
        
        const ideaIndex = allIdeas.findIndex(i => i.id === id);
        if (ideaIndex > -1) {
            allIdeas[ideaIndex].estado = newStatus;
            renderIdeas();
        }

        const { error } = await supabase.from('ideas').update({ estado: newStatus }).eq('id', id);
        if (error) {
            allIdeas[ideaIndex].estado = currentStatus;
            renderIdeas();
            alert("Error al actualizar.");
        }
    }

    // 7. CREAR IDEA (CORRECCIÓN DE FECHA)
    window.openModal = () => document.getElementById("ideaModal").classList.add("active");
    window.closeModal = () => document.getElementById("ideaModal").classList.remove("active");

    window.createIdea = async () => {
        const title = document.getElementById("ideaTitle").value;
        const type = document.getElementById("ideaType").value;
        const desc = document.getElementById("ideaDesc").value;

        if (!title || !desc) return alert("Completa todos los campos.");

        // SOLUCIÓN ZONA HORARIA: Construir fecha string "YYYY-MM-01" manualmente
        // Esto evita que "1 Ene 00:00" se convierta en "31 Dic"
        const year = viewDate.getFullYear();
        const month = viewDate.getMonth() + 1; // JS es 0-11, necesitamos 1-12
        const safeDateString = `${year}-${month.toString().padStart(2, '0')}-01`;

        const { data, error } = await supabase
            .from('ideas')
            .insert([{
                user_id: currentUser.id,
                titulo: title,
                tipo: type,
                descripcion: desc,
                estado: 'propuesta',
                origen: 'cliente',
                fecha: safeDateString // Usamos la fecha segura
            }])
            .select();

        if (error) {
            alert("Error: " + error.message);
        } else {
            allIdeas.unshift(data[0]);
            if(currentFilter === type) renderIdeas();
            else switchTab(type);
            closeModal();
            document.getElementById("ideaTitle").value = "";
            document.getElementById("ideaDesc").value = "";
        }
    }

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "index.html";
    });

    init();
  </script>
</body>
</html>