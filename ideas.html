<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>√Åpice Studio | Ideas Creativas</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    /* VARIABLES */
    :root { --apice-green: #8DA399; --apice-bg: #F7F6F2; --text-main: #1A1A1A; --text-soft: #666666; --white: #FFFFFF; --client-idea-bg: #F0EEE9; --border: rgba(0,0,0,0.08); --glass: rgba(255, 255, 255, 0.95); --font-serif: 'Cormorant Garamond', serif; --font-sans: 'Inter', sans-serif; --ease: cubic-bezier(0.23, 1, 0.32, 1); }
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    body { background: var(--apice-bg); color: var(--text-main); font-family: var(--font-sans); min-height: 100vh; overflow-x: hidden; opacity: 0; transition: opacity 1s var(--ease); background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E"); }
    .ambient-light { position: fixed; bottom: -10%; left: -10%; width: 60vw; height: 60vw; background: radial-gradient(circle, rgba(141,163,153,0.1) 0%, rgba(255,255,255,0) 60%); filter: blur(90px); z-index: -1; pointer-events: none; }
    .app-container { display: grid; grid-template-columns: 300px 1fr; min-height: 100vh; }
    .floating-nav-container { position: fixed; top: 40px; right: 50px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; }
    .menu-trigger { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; cursor: pointer; transition: 0.3s var(--ease); box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.6); }
    .menu-trigger span { width: 24px; height: 1.5px; background-color: var(--text-main); transition: 0.3s; }
    .menu-trigger.active { background: var(--white); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .nav-dropdown { position: absolute; top: 60px; right: 0; width: 220px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); border-radius: 16px; padding: 20px 0; box-shadow: 0 20px 60px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.5); opacity: 0; transform: translateY(-10px) scale(0.95); pointer-events: none; transition: all 0.4s var(--ease); transform-origin: top right; }
    .nav-dropdown.is-open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
    .nav-link { display: block; padding: 12px 25px; font-size: 13px; color: var(--text-soft); text-decoration: none; transition: 0.2s; letter-spacing: 0.5px; }
    .nav-link:hover { background: rgba(141, 163, 153, 0.08); color: var(--text-main); padding-left: 30px; }
    .nav-divider { height: 1px; background: rgba(0,0,0,0.05); margin: 10px 0; }
    .nav-link.danger { color: #D45D5D; }
    .sidebar { position: sticky; top: 0; height: 100vh; padding: 60px 40px; display: flex; flex-direction: column; justify-content: space-between; border-right: 1px solid rgba(0,0,0,0.05); background: var(--glass); backdrop-filter: blur(30px); z-index: 50; }
    .brand { font-family: var(--font-serif); font-size: 28px; letter-spacing: 0.02em; margin-bottom: 60px; display: block; color: var(--text-main); text-decoration: none; }
    .nav-section { display: flex; flex-direction: column; gap: 8px; margin-top: 20px; }
    .side-nav-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #999; text-decoration: none; transition: 0.3s; cursor: pointer; }
    .side-nav-item:hover, .side-nav-item.active { color: var(--apice-green); padding-left: 10px; font-weight: 600; }
    .side-nav-item.active { border-left: 2px solid var(--apice-green); padding-left: 15px; }
    .user-mini { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); }
    .user-name { font-size: 12px; font-weight: 600; display: block; }
    .user-role { font-size: 11px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
    .main-content { padding: 60px 80px; overflow-y: auto; padding-bottom: 120px; }
    .header-section { margin-bottom: 40px; display: flex; justify-content: space-between; align-items: flex-end; }
    .page-title { font-family: var(--font-serif); font-size: 48px; font-weight: 400; color: var(--text-main); margin-bottom: 10px; }
    .subtitle { font-size: 14px; color: var(--text-soft); max-width: 500px; line-height: 1.6; }
    .month-nav-container { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 40px; padding: 10px; }
    .month-display { font-family: var(--font-serif); font-size: 28px; font-style: italic; min-width: 180px; text-align: center; color: var(--text-main); }
    .nav-arrow { width: 40px; height: 40px; border: 1px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; background: var(--white); color: var(--text-main); font-size: 18px; }
    .nav-arrow:hover { border-color: var(--apice-green); color: var(--apice-green); transform: scale(1.05); }
    .btn-primary { background: var(--text-main); color: white; border: none; padding: 12px 24px; border-radius: 30px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
    .btn-primary:hover { background: var(--apice-green); transform: translateY(-2px); }
    .progress-section { background: var(--white); padding: 25px 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); margin-bottom: 40px; display: flex; align-items: center; justify-content: space-between; gap: 40px; border: 1px solid rgba(255,255,255,0.6); animation: fadeIn 0.8s var(--ease) backwards; }
    .prog-info h3 { font-size: 14px; margin-bottom: 5px; font-weight: 500; }
    .prog-info p { font-size: 12px; color: var(--text-soft); }
    .prog-bar-wrapper { flex: 1; height: 6px; background: #EEE; border-radius: 10px; overflow: hidden; position: relative; }
    .prog-fill { height: 100%; background: var(--apice-green); width: 0%; transition: width 1s var(--ease); border-radius: 10px; }
    .prog-number { font-family: var(--font-serif); font-size: 36px; color: var(--apice-green); min-width: 80px; text-align: right; font-style: italic; }
    .prog-label { font-size: 10px; text-transform: uppercase; color: #999; display: block; text-align: right; margin-top: 4px; }
    .tabs-container { display: flex; gap: 30px; margin-bottom: 30px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .tab-item { padding-bottom: 15px; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; color: #999; cursor: pointer; transition: 0.3s; position: relative; }
    .tab-item:hover { color: var(--text-main); } .tab-item.active { color: var(--text-main); font-weight: 600; } .tab-item.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: var(--apice-green); }
    .ideas-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; }
    .idea-card { background: var(--white); border-radius: 12px; padding: 30px; border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s var(--ease); display: flex; flex-direction: column; position: relative; cursor: default; min-height: 250px; }
    .idea-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.04); }
    .idea-card.is-client { background: var(--client-idea-bg); border: 1px dashed #D4A373; }
    .idea-card.is-client::after { content: 'TU PROPUESTA'; position: absolute; top: 0; left: 50%; transform: translateX(-50%); background: #D4A373; color: white; font-size: 8px; font-weight: 600; padding: 2px 8px; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; letter-spacing: 1px; }
    .idea-card.approved { border-color: var(--apice-green); border-style: solid; background: #F2F8F5; box-shadow: 0 10px 30px rgba(141, 163, 153, 0.15); }
    .idea-card.approved::before { content: 'SELECCIONADA'; position: absolute; top: 20px; right: 20px; font-size: 9px; color: var(--apice-green); font-weight: 700; letter-spacing: 1px; border: 1px solid var(--apice-green); padding: 4px 8px; border-radius: 4px; background: white; }
    .idea-card.ready { background: #E8F5E9; border-color: #2E7D32; }
    .idea-card.ready::before { content: 'LISTO PARA GRABAR üé•'; color: #2E7D32; border-color: #2E7D32; }
    .idea-type { font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: block; }
    .idea-title { font-family: var(--font-serif); font-size: 22px; line-height: 1.2; color: var(--text-main); margin-bottom: 15px; }
    .idea-desc { font-size: 14px; line-height: 1.6; color: var(--text-soft); margin-bottom: 30px; font-weight: 300; }
    .script-part { margin-bottom: 10px; }
    .script-label { font-size: 9px; text-transform: uppercase; color: #999; font-weight: 700; display: block; margin-bottom: 3px; }
    .script-text { font-size: 13px; line-height: 1.5; color: var(--text-soft); white-space: pre-wrap; }
    .btn-select { margin-top: auto; width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #E0E0E0; background: white; color: var(--text-soft); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: 0.3s; margin-top: 15px; }
    .btn-select:hover { border-color: var(--text-main); color: var(--text-main); }
    .btn-action-row { display: flex; gap: 10px; margin-top: auto; }
    .idea-card.approved .btn-select { background: var(--apice-green); color: white; border-color: var(--apice-green); }
    .idea-card.approved .btn-select:hover { background: #7A9187; }
    .selection-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--text-main); color: white; padding: 15px 30px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 20px; z-index: 100; opacity: 0; transition: 0.5s var(--ease); pointer-events: none; }
    .selection-bar.visible { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: all; }
    .selection-count { font-size: 14px; font-weight: 500; } .selection-detail { font-size: 12px; color: rgba(255,255,255,0.6); margin-left: auto; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30,30,30,0.4); backdrop-filter: blur(5px); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .modal-overlay.active { opacity: 1; pointer-events: all; }
    .upload-modal { background: var(--white); width: 500px; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); transform: translateY(20px); transition: 0.4s var(--ease); max-height: 90vh; overflow-y: auto; }
    .modal-overlay.active .upload-modal { transform: translateY(0); }
    .modal-title { font-family: var(--font-display); font-size: 28px; margin-bottom: 25px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #999; margin-bottom: 8px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 8px; font-family: var(--font-sans); font-size: 14px; outline: none; }
    .form-textarea { resize: vertical; min-height: 100px; }
    .form-input:focus, .form-textarea:focus { border-color: var(--apice-green); }
    .close-modal { position: absolute; top: 20px; right: 20px; cursor: pointer; color: #999; font-size: 20px; }
    
    /* Edit icon top-right */
    .edit-icon-btn { position: absolute; top: 20px; right: 20px; background: transparent; border: none; cursor: pointer; font-size: 16px; opacity: 0.5; transition: 0.3s; z-index: 5; }
    .edit-icon-btn:hover { opacity: 1; transform: scale(1.1); color: var(--apice-green); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div class="ambient-light"></div>
  <div class="floating-nav-container" id="navContainer">
    <div class="menu-trigger" id="menuTrigger"><span></span><span></span><span></span></div>
    <div class="nav-dropdown" id="navDropdown">
      <a href="material.html" class="nav-link">Material</a>
      <a href="ideas.html" class="nav-link" style="color:var(--apice-green);">Ideas</a>
      <a href="documentos.html" class="nav-link">Documentos</a>
      <div class="nav-divider"></div>
      <a href="dashboard.html" class="nav-link">Volver al Dashboard</a>
      <a href="#" id="logoutBtn" class="nav-link danger">Cerrar Sesi√≥n</a>
    </div>
  </div>
  <div class="app-container">
    <aside class="sidebar">
      <div>
        <a href="dashboard.html" class="brand">√Åpice Studio.</a>
        <nav class="nav-section">
          <div class="side-nav-item active" onclick="switchTab('reel')"><span>Propuestas Reels</span></div>
          <div class="side-nav-item" onclick="switchTab('carrusel')"><span>Propuestas Carruseles</span></div>
          <div class="side-nav-item" onclick="switchTab('guion')"><span>Propuestas Guiones</span></div>
        </nav>
      </div>
      <div class="user-mini"><span class="user-name" id="userName">Cargando...</span><span class="user-role" id="userPlan">Cuenta Premium</span></div>
    </aside>
    <main class="main-content">
      <header class="header-section">
        <div><h1 class="page-title">Estrategia Creativa</h1><p class="subtitle">Propuestas y Guiones para este mes.</p></div>
        <button class="btn-primary" onclick="openSmartModal()"><span>+</span> Nueva Idea</button>
      </header>
      <section class="progress-section">
        <div class="prog-info"><h3 id="goalTitle">Meta</h3><p>Seleccionadas vs Objetivo</p></div>
        <div class="prog-bar-wrapper"><div class="prog-fill" id="progressBar"></div></div>
        <div><div class="prog-number" id="progressText">0/0</div><span class="prog-label">Seleccionadas</span></div>
      </section>
      <div class="month-nav-container">
        <button class="nav-arrow" onclick="changeMonth(-1)">‚Üê</button>
        <div class="month-display" id="monthDisplay">...</div>
        <button class="nav-arrow" onclick="changeMonth(1)">‚Üí</button>
      </div>
      <div class="tabs-container">
        <div class="tab-item active" id="tab-reel" onclick="switchTab('reel')">Reels</div>
        <div class="tab-item" id="tab-carrusel" onclick="switchTab('carrusel')">Carruseles</div>
        <div class="tab-item" id="tab-guion" onclick="switchTab('guion')">Guiones</div>
      </div>
      <div class="ideas-grid" id="ideasGrid"><p style="color:#999;">Cargando...</p></div>
    </main>
  </div>
  <div class="selection-bar" id="selectionBar"><span class="selection-count" id="selectionText">0 ideas seleccionadas</span><span class="selection-detail">Sugerido: 8 a 12</span></div>
  
  <div class="modal-overlay" id="ideaModal">
    <div class="upload-modal">
      <div class="close-modal" onclick="closeIdeaModal()">‚úï</div>
      <h2 class="modal-title">Agregar Idea</h2>
      <div class="form-group"><label class="form-label">T√≠tulo</label><input type="text" id="ideaTitle" class="form-input"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select id="ideaType" class="form-select"><option value="reel">Reel</option><option value="carrusel">Carrusel</option></select></div>
      <div class="form-group"><label class="form-label">Descripci√≥n</label><textarea id="ideaDesc" class="form-textarea"></textarea></div>
      <button class="btn-primary" style="width:100%; justify-content:center;" onclick="createIdea()">Guardar</button>
    </div>
  </div>

  <div class="modal-overlay" id="scriptModal">
    <div class="upload-modal">
      <div class="close-modal" onclick="closeScriptModal()">‚úï</div>
      <h2 class="modal-title" id="scriptModalTitle">Editar mi Versi√≥n</h2>
      <p style="font-size:12px; color:#999; margin-bottom:20px;" id="scriptModalDesc">Est√°s creando tu propia versi√≥n de este guion.</p>
      <div class="form-group"><label class="form-label">T√≠tulo</label><input type="text" id="editScriptTitle" class="form-input"></div>
      <div class="form-group"><label class="form-label">Hook</label><textarea id="editScriptHook" class="form-textarea"></textarea></div>
      <div class="form-group"><label class="form-label">Desarrollo</label><textarea id="editScriptBody" class="form-textarea" style="min-height:150px;"></textarea></div>
      <div class="form-group"><label class="form-label">Moraleja</label><input type="text" id="editScriptMoral" class="form-input"></div>
      <div class="form-group"><label class="form-label">CTA</label><input type="text" id="editScriptCTA" class="form-input"></div>
      <button class="btn-primary" style="width:100%; justify-content:center;" onclick="saveDuplicateScript()">Guardar Mi Versi√≥n</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabaseUrl = "https://jmfnwxnzxcfhvrmsmfip.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptZm53eG56eGNmaHZybXNtZmlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzEwMzcsImV4cCI6MjA4NDUwNzAzN30.KzyZy_S1ufhLkv63Kvmz9lm_UrDssvUE34FxGAPYxZw";
    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentUser = null; let allData = []; let currentFilter = 'reel'; let viewDate = new Date();
    const navContainer = document.getElementById('navContainer'); const navDropdown = document.getElementById('navDropdown'); const menuTrigger = document.getElementById('menuTrigger'); let menuTimer;
    navContainer.addEventListener('mouseenter', () => { clearTimeout(menuTimer); navDropdown.classList.add('is-open'); menuTrigger.classList.add('active'); });
    navContainer.addEventListener('mouseleave', () => { menuTimer = setTimeout(() => { navDropdown.classList.remove('is-open'); menuTrigger.classList.remove('active'); }, 4000); });

    async function init() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = "index.html"; return; }
        currentUser = session.user; 
        
        let rawName = currentUser.email.split('@')[0];
        if (rawName.includes('.')) rawName = rawName.split('.')[0];
        document.getElementById("userName").innerText = rawName.charAt(0).toUpperCase() + rawName.slice(1);
        const { data: profile } = await supabase.from('perfiles').select('plan').eq('id', currentUser.id).single();
        if (profile) document.getElementById("userPlan").innerText = profile.plan;
        document.body.style.opacity = "1"; // HACER VISIBLE AQU√ç

        updateMonthDisplay(); await fetchData();
    }

    window.changeMonth = (delta) => { viewDate.setMonth(viewDate.getMonth() + delta); updateMonthDisplay(); renderData(); };
    function updateMonthDisplay() {
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        document.getElementById("monthDisplay").innerText = `${monthNames[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
    }

    async function fetchData() {
        const [ideasRes, scriptsRes] = await Promise.all([
            supabase.from('ideas').select('*').eq('user_id', currentUser.id),
            supabase.from('guiones').select('*').eq('user_id', currentUser.id)
        ]);
        const ideas = (ideasRes.data || []).map(i => ({...i, category: 'idea'}));
        const scripts = (scriptsRes.data || []).map(s => ({...s, category: 'script', tipo: 'guion'})); 
        allData = [...ideas, ...scripts]; renderData();
    }

    function renderData() {
        const grid = document.getElementById("ideasGrid"); grid.innerHTML = "";
        let filtered = allData.filter(item => {
            const dateStr = item.fecha || item.created_at;
            if(!dateStr) return false;
            const d = new Date(dateStr);
            return d.getMonth() === viewDate.getMonth() && d.getFullYear() === viewDate.getFullYear();
        });

        if (currentFilter === 'guion') { filtered = filtered.filter(item => item.category === 'script'); } 
        else { filtered = filtered.filter(item => item.category === 'idea' && item.tipo === currentFilter); }
        
        updateProgress(filtered);
        
        if (filtered.length === 0) { grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#999;">No hay contenido para este mes.</div>`; return; }
        
        filtered.forEach(item => {
            const card = document.createElement("div");
            if (item.category === 'idea') {
                const isApproved = item.estado === 'aprobada'; const isClient = item.origen === 'cliente';
                card.className = `idea-card ${isApproved ? 'approved' : ''} ${isClient ? 'is-client' : ''}`;
                card.innerHTML = `<span class="idea-type">${item.tipo}</span><h3 class="idea-title">${item.titulo}</h3><p class="idea-desc">${item.descripcion}</p><button class="btn-select" onclick="toggleStatus('ideas', ${item.id}, '${item.estado}')">${isApproved ? 'Seleccionada ‚úì' : 'Seleccionar'}</button>`;
            } else {
                const isClient = item.origen === 'cliente'; const isReady = item.estado === 'listo_grabar';
                const isApproved = item.estado === 'aprobado' || isReady; 
                card.className = `idea-card ${isApproved ? 'approved' : ''} ${isClient ? 'is-client' : ''} ${isReady ? 'ready' : ''}`;
                let buttonsHtml = '';
                if (isClient) {
                    const iconPencil = `<button class="edit-icon-btn" onclick="openDuplicateModal(${item.id}, true)">‚úèÔ∏è</button>`;
                    buttonsHtml = `<div class="btn-action-row"><button class="btn-select" onclick="toggleStatus('guiones', ${item.id}, '${item.estado}')">${isApproved && !isReady ? 'Seleccionada ‚úì' : 'Seleccionar'}</button><button class="btn-select" style="${isReady ? 'background:#2E7D32; color:white; border-color:#2E7D32;' : ''}" onclick="toggleStatus('guiones', ${item.id}, '${item.estado}', true)">${isReady ? 'Listo üé•' : 'Marcar para Grabar'}</button></div>`;
                    card.innerHTML = `${iconPencil}<span class="idea-type">GUION (Tu Versi√≥n)</span><h3 class="idea-title">${item.titulo}</h3><div class="script-part"><span class="script-label">HOOK</span><p class="script-text">${item.hook || '-'}</p></div><div class="script-part"><span class="script-label">DESARROLLO</span><p class="script-text">${item.desarrollo || '-'}</p></div><div class="script-part"><span class="script-label">CTA</span><p class="script-text">${item.cta || '-'}</p></div>${buttonsHtml}`;
                } else {
                    const iconDup = `<button class="edit-icon-btn" onclick="openDuplicateModal(${item.id}, false)">üìÑ</button>`;
                    buttonsHtml = `<div class="btn-action-row"><button class="btn-select" onclick="toggleStatus('guiones', ${item.id}, '${item.estado}')">${isApproved ? 'Seleccionada ‚úì' : 'Seleccionar'}</button></div>`;
                    card.innerHTML = `${iconDup}<span class="idea-type">GUION ORIGINAL</span><h3 class="idea-title">${item.titulo}</h3><div class="script-part"><span class="script-label">HOOK</span><p class="script-text">${item.hook || '-'}</p></div><div class="script-part"><span class="script-label">DESARROLLO</span><p class="script-text">${item.desarrollo || '-'}</p></div><div class="script-part"><span class="script-label">CTA</span><p class="script-text">${item.cta || '-'}</p></div>${buttonsHtml}`;
                }
            }
            grid.appendChild(card);
        });
    }

    window.switchTab = (type) => {
        currentFilter = type; document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active')); document.getElementById(`tab-${type}`).classList.add('active');
        document.querySelectorAll('.side-nav-item').forEach(el => el.classList.remove('active')); renderData();
    }

    function updateProgress(items) {
        let goal = 12; if (currentFilter === 'carrusel') goal = 6; if (currentFilter === 'guion') goal = 8;
        document.getElementById("goalTitle").innerText = `Meta de ${currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1)}s`;
        const count = items.filter(i => i.estado === 'aprobada' || i.estado === 'aprobado' || i.estado === 'listo_grabar').length;
        const percent = Math.min((count / goal) * 100, 100);
        document.getElementById("progressBar").style.width = `${percent}%`; document.getElementById("progressText").innerText = `${count}/${goal}`;
    }

    window.toggleStatus = async (table, id, currentStatus, isScriptReadyToggle = false) => {
        let newStatus;
        if (isScriptReadyToggle) { newStatus = currentStatus === 'listo_grabar' ? 'propuesta' : 'listo_grabar'; } 
        else { newStatus = currentStatus === 'aprobada' || currentStatus === 'aprobado' ? 'propuesta' : (table === 'guiones' ? 'aprobado' : 'aprobada'); }
        const { error } = await supabase.from(table).update({ estado: newStatus }).eq('id', id); if(!error) fetchData();
    }

    window.openSmartModal = () => {
        if (currentFilter === 'guion') {
            editingScriptId = null; isEditingExisting = false;
            document.getElementById("scriptModalTitle").innerText = "Nuevo Guion"; document.getElementById("scriptModalDesc").innerText = "Redacta una propuesta desde cero.";
            document.getElementById("editScriptTitle").value = ""; document.getElementById("editScriptHook").value = ""; document.getElementById("editScriptBody").value = ""; document.getElementById("editScriptMoral").value = ""; document.getElementById("editScriptCTA").value = "";
            document.getElementById("scriptModal").classList.add("active");
        } else {
            document.getElementById("ideaType").value = currentFilter; document.getElementById("ideaModal").classList.add("active");
        }
    }
    window.closeIdeaModal = () => document.getElementById("ideaModal").classList.remove("active");
    window.createIdea = async () => {
        const title = document.getElementById("ideaTitle").value; const type = document.getElementById("ideaType").value; const desc = document.getElementById("ideaDesc").value;
        if (!title) return alert("Falta t√≠tulo");
        const year = viewDate.getFullYear(); const month = viewDate.getMonth() + 1; const safeDateString = `${year}-${month.toString().padStart(2, '0')}-01`;
        await supabase.from('ideas').insert([{ user_id: currentUser.id, titulo: title, tipo: type, descripcion: desc, estado: 'propuesta', origen: 'cliente', fecha: safeDateString }]);
        closeIdeaModal(); fetchData();
    }
    
    // DUPLICATE LOGIC
    let editingScriptId = null; let isEditingExisting = false;
    window.openDuplicateModal = (scriptId, isEdit) => {
        const script = allData.find(s => s.id === scriptId);
        editingScriptId = scriptId; isEditingExisting = isEdit;
        document.getElementById("scriptModalTitle").innerText = isEdit ? "Editar mi Versi√≥n" : "Duplicar y Editar";
        document.getElementById("scriptModalDesc").innerText = isEdit ? "Modifica tu propuesta." : "Se crear√° una copia editable de este guion.";
        document.getElementById("editScriptTitle").value = script.titulo; document.getElementById("editScriptHook").value = script.hook;
        document.getElementById("editScriptBody").value = script.desarrollo; document.getElementById("editScriptMoral").value = script.moraleja; document.getElementById("editScriptCTA").value = script.cta;
        document.getElementById("scriptModal").classList.add("active");
    }
    window.closeScriptModal = () => document.getElementById("scriptModal").classList.remove("active");

    window.saveDuplicateScript = async () => {
        const data = { titulo: document.getElementById("editScriptTitle").value, hook: document.getElementById("editScriptHook").value, desarrollo: document.getElementById("editScriptBody").value, moraleja: document.getElementById("editScriptMoral").value, cta: document.getElementById("editScriptCTA").value };
        
        if (editingScriptId === null) {
             const year = viewDate.getFullYear(); const month = viewDate.getMonth() + 1; const safeDateString = `${year}-${month.toString().padStart(2, '0')}-01`;
             const newData = { ...data, user_id: currentUser.id, origen: 'cliente', estado: 'propuesta', fecha: safeDateString };
             await supabase.from('guiones').insert([newData]);
        } else if (isEditingExisting) {
            await supabase.from('guiones').update(data).eq('id', editingScriptId);
        } else {
            const original = allData.find(s => s.id === editingScriptId);
            const newData = { ...data, user_id: currentUser.id, origen: 'cliente', estado: 'propuesta', fecha: original.fecha, padre_id: original.id };
            await supabase.from('guiones').insert([newData]);
        }
        closeScriptModal(); fetchData();
    }

    document.getElementById("logoutBtn").addEventListener("click", async () => { await supabase.auth.signOut(); window.location.href = "index.html"; });
    init();
  </script>
</body>
</html>