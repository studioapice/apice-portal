<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>√Åpice Studio | Gestor de Material</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    :root { --apice-green: #8DA399; --apice-bg: #F7F6F2; --text-main: #1A1A1A; --text-soft: #666666; --white: #FFFFFF; --border: rgba(0,0,0,0.08); --glass: rgba(255, 255, 255, 0.95); --font-serif: 'Cormorant Garamond', serif; --font-sans: 'Inter', sans-serif; --ease: cubic-bezier(0.23, 1, 0.32, 1); }
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    body { background: var(--apice-bg); color: var(--text-main); font-family: var(--font-sans); min-height: 100vh; overflow-x: hidden; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E"); }
    .ambient-light { position: fixed; top: -10%; right: -10%; width: 60vw; height: 60vw; background: radial-gradient(circle, rgba(141,163,153,0.1) 0%, rgba(255,255,255,0) 60%); filter: blur(90px); z-index: -1; pointer-events: none; }
    .app-container { display: grid; grid-template-columns: 300px 1fr; min-height: 100vh; }
    .floating-nav-container { position: fixed; top: 40px; right: 50px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; }
    .menu-trigger { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; cursor: pointer; transition: 0.3s var(--ease); box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.6); }
    .menu-trigger span { width: 24px; height: 1.5px; background-color: var(--text-main); transition: 0.3s; }
    .menu-trigger.active { background: var(--white); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .nav-dropdown { position: absolute; top: 60px; right: 0; width: 220px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); border-radius: 16px; padding: 20px 0; box-shadow: 0 20px 60px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.5); opacity: 0; transform: translateY(-10px) scale(0.95); pointer-events: none; transition: all 0.4s var(--ease); transform-origin: top right; }
    .nav-dropdown.is-open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
    .nav-link { display: block; padding: 12px 25px; font-size: 13px; color: var(--text-soft); text-decoration: none; transition: 0.2s; letter-spacing: 0.5px; }
    .nav-link:hover { background: rgba(141, 163, 153, 0.08); color: var(--text-main); padding-left: 30px; }
    .nav-divider { height: 1px; background: rgba(0,0,0,0.05); margin: 10px 0; }
    .nav-link.danger { color: #D45D5D; } .nav-link.danger:hover { background: rgba(212, 93, 93, 0.05); }
    .sidebar { position: sticky; top: 0; height: 100vh; padding: 60px 40px; display: flex; flex-direction: column; justify-content: space-between; border-right: 1px solid rgba(0,0,0,0.05); background: var(--glass); backdrop-filter: blur(30px); z-index: 50; }
    .brand { font-family: var(--font-serif); font-size: 28px; letter-spacing: 0.02em; margin-bottom: 60px; display: block; color: var(--text-main); text-decoration: none; }
    .nav-section { display: flex; flex-direction: column; gap: 8px; margin-top: 20px; }
    .side-nav-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #999; text-decoration: none; transition: 0.3s; cursor: pointer; }
    .side-nav-item:hover, .side-nav-item.active { color: var(--apice-green); padding-left: 10px; font-weight: 600; }
    .side-nav-item.active { border-left: 2px solid var(--apice-green); padding-left: 15px; }
    .user-mini { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); }
    .user-name { font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px; }
    .user-role { font-size: 11px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
    .main-content { padding: 60px 80px; overflow-y: auto; }
    .header-section { margin-bottom: 50px; display: flex; justify-content: space-between; align-items: flex-end; }
    .page-title { font-family: var(--font-serif); font-size: 48px; font-weight: 400; color: var(--text-main); margin-bottom: 10px; }
    .subtitle { font-size: 14px; color: var(--text-soft); max-width: 500px; line-height: 1.6; }
    .btn-primary { background: var(--text-main); color: white; border: none; padding: 12px 24px; border-radius: 30px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
    .btn-primary:hover { background: var(--apice-green); transform: translateY(-2px); }
    .files-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 25px; margin-top: 40px; animation: fadeIn 0.5s ease; }
    .file-card { background: var(--white); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.03); transition: all 0.3s var(--ease); display: flex; flex-direction: column; border: 1px solid transparent; cursor: default; }
    .file-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(141, 163, 153, 0.15); border-color: rgba(141, 163, 153, 0.3); }
    .file-preview { height: 140px; width: 100%; background: #F8F8F8; display: flex; align-items: center; justify-content: center; font-size: 32px; position: relative; }
    .preview-doc { background: #F2F0EB; color: #8DA399; } .preview-video { background: #EAEAEA; color: #1A1A1A; } .preview-img { background: #F9F9F9; color: #D4A373; }
    .file-info { padding: 20px; flex: 1; display: flex; flex-direction: column; }
    .file-tag { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: #999; margin-bottom: 8px; }
    .file-name { font-size: 14px; font-weight: 500; color: var(--text-main); margin-bottom: 20px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .btn-download-small { margin-top: auto; align-self: flex-start; font-size: 11px; text-decoration: none; color: var(--text-main); border-bottom: 1px solid #DDD; padding-bottom: 2px; transition: 0.3s; }
    .btn-download-small:hover { border-color: var(--apice-green); color: var(--apice-green); }
    .links-list { display: flex; flex-direction: column; gap: 15px; margin-top: 40px; animation: fadeIn 0.5s ease; }
    .link-row { background: var(--white); padding: 20px 30px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(0,0,0,0.05); transition: 0.3s; }
    .link-row:hover { border-color: var(--apice-green); transform: translateX(5px); }
    .link-icon { width: 40px; height: 40px; background: rgba(141, 163, 153, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--apice-green); margin-right: 20px; }
    .link-details { flex: 1; } .link-title { font-size: 14px; font-weight: 500; color: var(--text-main); margin-bottom: 4px; } .link-url { font-size: 11px; color: #999; }
    .btn-visit { padding: 8px 16px; background: transparent; border: 1px solid #E0E0E0; border-radius: 20px; font-size: 11px; color: var(--text-main); text-decoration: none; transition: 0.3s; }
    .btn-visit:hover { background: var(--text-main); color: white; border-color: var(--text-main); }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30,30,30,0.4); backdrop-filter: blur(5px); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .modal-overlay.active { opacity: 1; pointer-events: all; }
    .upload-modal { background: var(--white); width: 450px; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); transform: translateY(20px); transition: 0.4s var(--ease); }
    .modal-overlay.active .upload-modal { transform: translateY(0); }
    .modal-title { font-family: var(--font-display); font-size: 28px; margin-bottom: 25px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #999; margin-bottom: 8px; }
    .form-input, .form-select { width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 8px; font-family: var(--font-sans); font-size: 14px; outline: none; }
    .form-input:focus { border-color: var(--apice-green); }
    .drop-zone { border: 2px dashed #DDD; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; background: #FAFAFA; }
    .drop-zone:hover { border-color: var(--apice-green); background: rgba(141, 163, 153, 0.05); }
    .drop-text { font-size: 13px; color: #888; margin-top: 10px; pointer-events: none; }
    .close-modal { position: absolute; top: 20px; right: 20px; cursor: pointer; color: #999; font-size: 20px; }
    .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--apice-green); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: none; margin-right: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="ambient-light"></div>
  <div class="floating-nav-container" id="navContainer">
    <div class="menu-trigger" id="menuTrigger"><span></span><span></span><span></span></div>
    <div class="nav-dropdown" id="navDropdown">
      <a href="material.html" class="nav-link" style="color:var(--apice-green);">Material</a>
      <a href="ideas.html" class="nav-link">Ideas</a>
      <a href="documentos.html" class="nav-link">Documentos</a>
      <div class="nav-divider"></div>
      <a href="dashboard.html" class="nav-link">Volver al Dashboard</a>
      <a href="#" id="logoutBtn" class="nav-link danger">Cerrar Sesi√≥n</a>
    </div>
  </div>
  <div class="app-container">
    <aside class="sidebar">
      <div>
        <a href="dashboard.html" class="brand">√Åpice Studio.</a>
        <nav class="nav-section">
          <div class="side-nav-item active" onclick="filterView('all', this)"><span>1. Repositorio Material</span></div>
          <div class="side-nav-item" onclick="filterView('docs', this)"><span>2. Manuales & Gu√≠as</span></div>
          <div class="side-nav-item" onclick="filterView('media', this)"><span>3. Archivos Multimedia</span></div>
          <div class="side-nav-item" onclick="filterView('links', this)"><span>4. Links Externos</span></div>
        </nav>
      </div>
      <div class="user-mini"><span class="user-name" id="userName">Cargando...</span><span class="user-role" id="userPlan">Cuenta Cliente</span></div>
    </aside>
    <main class="main-content">
      <header class="header-section">
        <div><h1 class="page-title" id="sectionTitle">Repositorio Material</h1><p class="subtitle" id="sectionSubtitle">Vista general de todos tus archivos subidos a la plataforma.</p></div>
        <button class="btn-primary" id="mainActionBtn" onclick="openUploadModal()"><span>+</span> Subir Archivo</button>
      </header>
      <div class="files-grid" id="filesGrid"><p style="color:#999; font-size:14px;">Cargando...</p></div>
      <div class="links-list hidden" id="linksList"></div>
    </main>
  </div>
  <div class="modal-overlay" id="uploadModal">
    <div class="upload-modal">
      <div class="close-modal" onclick="closeUploadModal()">‚úï</div>
      <h2 class="modal-title" id="modalHeaderTitle">Subir Material</h2>
      <div class="form-group"><label class="form-label">T√≠tulo</label><input type="text" id="resourceTitle" class="form-input" placeholder="Ej: Manual de Marca"></div>
      <div class="form-group"><label class="form-label">Tipo</label>
        <select id="resourceType" class="form-select" onchange="toggleInputType()">
          <option value="manual">Manual / Documento</option><option value="video">Video</option><option value="foto">Fotograf√≠a</option><option value="link">Link Externo (Drive/Wetransfer)</option>
        </select>
      </div>
      <div class="form-group" id="fileInputGroup"><div class="drop-zone" id="dropZone"><span style="font-size:24px;">‚òÅÔ∏è</span><p class="drop-text" id="dropText">Haz click para seleccionar archivo</p><input type="file" id="fileInput" style="display:none"></div></div>
      <div class="form-group hidden" id="urlInputGroup"><label class="form-label">Pegar URL Externa</label><input type="url" id="urlInput" class="form-input" placeholder="https://drive.google.com/..."></div>
      <button class="btn-primary" style="width:100%; justify-content:center;" onclick="uploadResource()"><div class="loader" id="uploadLoader"></div><span id="uploadBtnText">Guardar</span></button>
    </div>
  </div>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabaseUrl = "https://jmfnwxnzxcfhvrmsmfip.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptZm53eG56eGNmaHZybXNtZmlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzEwMzcsImV4cCI6MjA4NDUwNzAzN30.KzyZy_S1ufhLkv63Kvmz9lm_UrDssvUE34FxGAPYxZw";
    const supabase = createClient(supabaseUrl, supabaseKey);
    let currentUser = null; let allMaterials = []; let currentView = 'all';
    const navContainer = document.getElementById('navContainer'); const navDropdown = document.getElementById('navDropdown'); const menuTrigger = document.getElementById('menuTrigger'); let menuTimer;
    navContainer.addEventListener('mouseenter', () => { clearTimeout(menuTimer); navDropdown.classList.add('is-open'); menuTrigger.classList.add('active'); });
    navContainer.addEventListener('mouseleave', () => { menuTimer = setTimeout(() => { navDropdown.classList.remove('is-open'); menuTrigger.classList.remove('active'); }, 4000); });
    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { window.location.href = "index.html"; return; }
      currentUser = session.user; 
      
      // LOGICA NOMBRE
      let rawName = currentUser.email.split('@')[0];
      if (rawName.includes('.')) rawName = rawName.split('.')[0];
      const displayName = rawName.charAt(0).toUpperCase() + rawName.slice(1);
      document.getElementById("userName").innerText = displayName;

      // LOGICA PLAN
      const { data: profile } = await supabase.from('perfiles').select('plan').eq('id', currentUser.id).single();
      if (profile && profile.plan) document.getElementById("userPlan").innerText = profile.plan;

      await fetchMaterials(); filterView('all', document.querySelector('.side-nav-item.active'));
    }
    async function fetchMaterials() { const { data, error } = await supabase.from('materiales').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }); if (error) console.error(error); else allMaterials = data || []; }
    window.filterView = (viewType, element) => {
        currentView = viewType;
        document.querySelectorAll('.side-nav-item').forEach(el => el.classList.remove('active')); if(element) element.classList.add('active');
        const titleEl = document.getElementById('sectionTitle'); const subEl = document.getElementById('sectionSubtitle'); const btnEl = document.getElementById('mainActionBtn'); const gridEl = document.getElementById('filesGrid'); const listEl = document.getElementById('linksList');
        gridEl.classList.remove('hidden'); listEl.classList.add('hidden'); let filteredData = [];
        if (viewType === 'all') { titleEl.innerText = "Repositorio Material"; subEl.innerText = "Vista general de documentos y archivos multimedia (excluyendo links)."; btnEl.innerHTML = "<span>+</span> Subir Archivo"; filteredData = allMaterials.filter(m => m.tipo !== 'link'); renderCards(filteredData); } 
        else if (viewType === 'docs') { titleEl.innerText = "Manuales & Gu√≠as"; subEl.innerText = "Documentaci√≥n t√©cnica y gu√≠as."; btnEl.innerHTML = "<span>+</span> Subir Documento"; filteredData = allMaterials.filter(m => m.tipo === 'manual'); renderCards(filteredData); }
        else if (viewType === 'media') { titleEl.innerText = "Archivos Multimedia"; subEl.innerText = "Repositorio visual: Fotos y Videos."; btnEl.innerHTML = "<span>+</span> Subir Multimedia"; filteredData = allMaterials.filter(m => m.tipo === 'video' || m.tipo === 'foto'); renderCards(filteredData); }
        else if (viewType === 'links') { titleEl.innerText = "Links Externos"; subEl.innerText = "Enlaces a carpetas externas."; btnEl.innerHTML = "<span>+</span> Agregar Link"; gridEl.classList.add('hidden'); listEl.classList.remove('hidden'); filteredData = allMaterials.filter(m => m.tipo === 'link'); renderLinks(filteredData); }
    };
    function renderCards(files) {
        const grid = document.getElementById("filesGrid"); grid.innerHTML = "";
        if (files.length === 0) { grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#999; border:2px dashed #E0E0E0; border-radius:12px;">No hay archivos en esta secci√≥n.</div>'; return; }
        files.forEach(file => {
            const card = document.createElement("div"); card.className = "file-card";
            let icon = "üìÑ"; let previewClass = "preview-doc"; if (file.tipo === 'video') { icon = "üé¨"; previewClass = "preview-video"; } if (file.tipo === 'foto') { icon = "üì∑"; previewClass = "preview-img"; }
            card.innerHTML = `<div class="file-preview ${previewClass}"><span>${icon}</span></div><div class="file-info"><span class="file-tag">${file.tipo}</span><h3 class="file-name" title="${file.titulo}">${file.titulo}</h3><a href="${file.archivo_url}" target="_blank" class="btn-download-small" download>Descargar</a></div>`;
            grid.appendChild(card);
        });
    }
    function renderLinks(links) {
        const list = document.getElementById("linksList"); list.innerHTML = "";
        if (links.length === 0) { list.innerHTML = '<div style="text-align:center; padding:40px; color:#999; border:2px dashed #E0E0E0; border-radius:12px;">No hay links guardados.</div>'; return; }
        links.forEach(link => {
            const row = document.createElement("div"); row.className = "link-row";
            row.innerHTML = `<div style="display:flex; align-items:center;"><div class="link-icon">üîó</div><div class="link-details"><div class="link-title">${link.titulo}</div><div class="link-url">${link.archivo_url}</div></div></div><a href="${link.archivo_url}" target="_blank" class="btn-visit">Abrir Enlace</a>`;
            list.appendChild(row);
        });
    }
    window.openUploadModal = () => { document.getElementById("uploadModal").classList.add("active"); const select = document.getElementById("resourceType"); if (currentView === 'docs') select.value = 'manual'; else if (currentView === 'media') select.value = 'foto'; else if (currentView === 'links') select.value = 'link'; else select.value = 'manual'; toggleInputType(); }
    window.closeUploadModal = () => { document.getElementById("uploadModal").classList.remove("active"); }
    window.toggleInputType = () => { const type = document.getElementById("resourceType").value; const fileGroup = document.getElementById("fileInputGroup"); const urlGroup = document.getElementById("urlInputGroup"); const btnText = document.getElementById("uploadBtnText"); if (type === 'link') { fileGroup.classList.add("hidden"); urlGroup.classList.remove("hidden"); btnText.innerText = "Guardar Link"; } else { fileGroup.classList.remove("hidden"); urlGroup.classList.add("hidden"); btnText.innerText = "Subir a la Plataforma"; } }
    const dropZone = document.getElementById("dropZone"); const fileInput = document.getElementById("fileInput"); dropZone.onclick = () => fileInput.click(); fileInput.onchange = () => { if(fileInput.files.length > 0) { document.getElementById("dropText").innerText = fileInput.files[0].name; dropZone.style.borderColor = "#8DA399"; } };
    window.uploadResource = async () => {
        const title = document.getElementById("resourceTitle").value; const type = document.getElementById("resourceType").value; const btnText = document.getElementById("uploadBtnText"); const loader = document.getElementById("uploadLoader");
        if (!title) return alert("Falta el t√≠tulo.");
        const originalBtnText = btnText.innerText; btnText.innerText = "Procesando..."; loader.style.display = "inline-block";
        try {
            let finalUrl = "";
            if (type === 'link') { const url = document.getElementById("urlInput").value; if (!url) throw new Error("Debes pegar una URL."); finalUrl = url; } 
            else {
                const file = fileInput.files[0]; if (!file) throw new Error("Debes seleccionar un archivo.");
                const filePath = `${currentUser.id}/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`;
                const { error: uploadError } = await supabase.storage.from('archivos_cliente').upload(filePath, file);
                if (uploadError) throw uploadError;
                const { data: { publicUrl } } = supabase.storage.from('archivos_cliente').getPublicUrl(filePath); finalUrl = publicUrl;
            }
            const { error: dbError } = await supabase.from('materiales').insert([{ user_id: currentUser.id, titulo: title, tipo: type, archivo_url: finalUrl }]);
            if (dbError) throw dbError;
            alert("Guardado correctamente."); closeUploadModal();
            document.getElementById("resourceTitle").value = ""; document.getElementById("urlInput").value = ""; document.getElementById("fileInput").value = null; document.getElementById("dropText").innerText = "Haz click para seleccionar archivo";
            await fetchMaterials(); filterView(currentView);
        } catch (err) { console.error(err); alert("Error: " + err.message); } finally { btnText.innerText = originalBtnText; loader.style.display = "none"; }
    };
    document.getElementById("logoutBtn").addEventListener("click", async () => { await supabase.auth.signOut(); window.location.href = "index.html"; });
    init();
  </script>
</body>
</html>